#!/usr/bin/env bash

function error_handler() {
  >&2 echo "Exited with BAD EXIT CODE '${2}' in ${0} script at line: ${1}."
  exit "$2"
}
trap 'error_handler ${LINENO} $?' ERR
set -o errtrace -o errexit -o nounset -o pipefail

# Read the checklist file and process each checked item
while IFS= read -r line; do
  if [[ $line =~ ^-\ \[x\] ]]; then
    # Extract the spec path and derive the test file path
    spec_path=$(echo $line | awk '{print $3}')

    initial_test_dirname=$(dirname "$spec_path")
    if [[ "$initial_test_dirname" == "spec" ]]; then
      test_dirname="browser_tests"
    else
      test_dirname="browser_tests/${initial_test_dirname/spec\//}"
    fi
    test_file="test_$(basename "$spec_path" | sed -E 's/\.md$/.py/')"
    test_file_path="${test_dirname}/${test_file}"

    # Run the test file using pytest
    echo "Running test: $test_file_path"
    pytest -s "$test_file_path"

    # Check the exit status of pytest
    if [[ $? -ne 0 ]]; then
      echo "Test failed: $test_file_path"
      exit 1
    fi
  fi
done <checklist.md

echo "All checked tests passed successfully."
